# LAB03: AWS IAM ‚Äì Users, Groups, and Policies (Console & CLI)

## üß† Lab Overview

In this lab, you'll explore **AWS Identity and Access Management (IAM)**. IAM allows you to securely manage access to AWS services and resources. You'll learn how to create IAM users and groups, attach policies, and test access permissions using both the **AWS Management Console** and **AWS CLI**.

IAM is essential for implementing the principle of least privilege, managing team access, and enabling automation securely.

### üìö Core Concepts for Beginners

- **What is IAM?** Identity and Access Management is AWS's security system that controls who can access your AWS resources and what they can do with them.
- **Authentication vs. Authorization**: Authentication proves you are who you say you are (via login credentials). Authorization determines what you're allowed to do (via policies).
- **IAM User**: An identity representing a person or application that needs access to AWS.
- **IAM Group**: A collection of users that makes permission management easier.
- **IAM Policy**: A document that defines permissions - what actions are allowed or denied on which resources.
- **Principle of Least Privilege**: Only grant the minimum permissions necessary to perform a task.

### üí° Real-World Comparison
Think of IAM as a corporate office building's security system:
- **Users** are like employees with ID badges
- **Groups** are like departments (Sales, IT, Finance)
- **Policies** are like access rules (who can enter which rooms)
- **Roles** (covered in later labs) are like temporary visitor passes

## üéØ Objectives

By the end of this lab, you will:

- Understand the core concepts of IAM
- Create IAM users and groups using the Console and CLI
- Attach policies (e.g., `AmazonS3ReadOnlyAccess`)
- Test user access to AWS services
- Understand how to implement least privilege access

## üõ†Ô∏è Prerequisites

- AWS account
- AWS CLI installed and configured as an admin (refer to the [CLI Setup Guide](../../CLI-Setup.md))
- IAM full access for your current user or role

## üìã Part 1: Create IAM User and Group (Console)

### Step 1: Navigate to IAM Service
1. Log in to the [AWS Management Console](https://console.aws.amazon.com)
2. In the search bar at the top, type "IAM" and select the "IAM" service from the dropdown
3. You'll be taken to the IAM Dashboard
4. Note the "Security Status" section which provides best practices for securing your AWS account

### Step 2: Create an IAM Group
1. In the left navigation menu, click on **User groups**
2. Click the **Create group** button
3. On the "Create user group" page:
   - **User group name**: Enter `lab03-s3read-group`
   - Under "Attach permissions policies", search for "S3"
   - Find and check the box for `AmazonS3ReadOnlyAccess`
   - This policy will allow users in this group to view and list S3 buckets and objects, but not modify them
4. Scroll down and click **Create group**
5. You should see your new group in the list with the policy attached

### Step 3: Create an IAM User
1. In the left navigation menu, click on **Users**
2. Click the **Add users** button
3. On the "Specify user details" page:
   - **User name**: Enter `lab03-s3-user`
   - Under "Select AWS access type":
     - Check **Access key - Programmatic access** (for CLI/API)
     - Optionally, check **Password - AWS Management Console access** if you want to test console login
     - If you selected console access, choose "Autogenerated password" and "Require password reset"
4. Click **Next: Permissions**

### Step 4: Add User to the Group
1. On the "Set permissions" page, select the **Add user to group** tab
2. Check the box next to your `lab03-s3read-group` created earlier
3. Click **Next: Tags**

### Step 5: Add Tags (Optional)
1. Tags help organize and identify users. Add these optional tags:
   - Key: `Department`, Value: `Training`
   - Key: `Purpose`, Value: `Lab03`
2. Click **Next: Review**

### Step 6: Review and Create
1. Review all the information:
   - User details (name and access types)
   - Permissions summary (should show S3 Read-only via group)
   - Tags (if you added any)
2. Click **Create user**

### Step 7: Save Credentials
1. On the success page, you'll see:
   - Access key ID and Secret access key (if you selected programmatic access)
   - Password (if you selected console access)
2. Click **Download .csv** to save these credentials securely
3. **IMPORTANT**: This is the only time AWS shows you the secret access key. Save it securely!
4. Click **Close**

### Step 8: Verify Group Membership
1. Click on your newly created user from the users list
2. Go to the "Groups" tab
3. Confirm that the user is a member of the `lab03-s3read-group`

## üõ°Ô∏è Part 2: Test IAM User Permissions (Console)

### Step 1: Test S3 Read Access (if you enabled console access)
1. Open a new browser window or private/incognito window 
2. Navigate to the [AWS Console Sign-in page](https://console.aws.amazon.com)
3. Choose "IAM user" sign-in option
4. Enter your:
   - Account ID (12-digit number found in your main AWS account)
   - Username: `lab03-s3-user`
   - Password: From the downloaded .csv file
5. After logging in, search for and navigate to the S3 service
6. You should be able to:
   - See a list of all buckets
   - Click into buckets and view objects
7. Try to create a bucket or upload a file - you should get "Access Denied" errors

### Step 2: Check IAM Permissions (Console)
1. While still logged in as the IAM user, go to the IAM service
2. You should have very limited access in IAM
3. This demonstrates the principle of least privilege - the user only has the permissions needed to do their job (view S3)

## üíª Part 3: IAM Management via AWS CLI

Now let's perform similar operations using the AWS Command Line Interface.

### Step 1: Verify Your AWS CLI Configuration
```bash
aws iam get-user
```
This should return information about your current IAM user, confirming your CLI is configured properly.

### Step 2: Create an IAM Group
```bash
aws iam create-group --group-name lab03-ec2read-group
```
This command creates a new IAM group for EC2 read-only access.

### Step 3: Find and Attach Policy to Group
First, let's find the appropriate policy:
```bash
aws iam list-policies --query "Policies[?contains(PolicyName, 'EC2ReadOnly')]"
```

Now attach the EC2 read-only policy to the group:
```bash
aws iam attach-group-policy \
  --group-name lab03-ec2read-group \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
```

### Step 4: Verify Policy Attachment
```bash
aws iam list-attached-group-policies \
  --group-name lab03-ec2read-group
```
You should see the EC2 read-only policy in the output.

### Step 5: Create an IAM User
```bash
aws iam create-user --user-name lab03-ec2-user
```

### Step 6: Add User to Group
```bash
aws iam add-user-to-group \
  --user-name lab03-ec2-user \
  --group-name lab03-ec2read-group
```

### Step 7: Verify Group Membership
```bash
aws iam get-group --group-name lab03-ec2read-group
```
The output should list `lab03-ec2-user` as a member.

### Step 8: Create Access Keys for the User
```bash
aws iam create-access-key --user-name lab03-ec2-user
```
**IMPORTANT**: The response contains both the Access Key ID and Secret Access Key. Save these securely - this is the only time you'll see the secret key!

Example output:
```json
{
    "AccessKey": {
        "UserName": "lab03-ec2-user",
        "AccessKeyId": "AKIAIOSFODNN7EXAMPLE",
        "Status": "Active",
        "SecretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
        "CreateDate": "2023-04-28T18:46:47+00:00"
    }
}
```

## üîë Part 4: Test Permissions Using the New User's Credentials

### Step 1: Set Up a New AWS CLI Profile
```bash
aws configure --profile lab03-ec2-user
```
When prompted, enter:
- The Access Key ID and Secret Access Key from the previous step
- Region: `eu-west-1`
- Output format: `json`

### Step 2: Test S3 Access with the New User
```bash
aws s3 ls --profile lab03-ec2-user
```
This should fail with an access denied error since this user only has EC2 permissions, not S3.

### Step 3: Test EC2 Read Access
```bash
aws ec2 describe-instances --profile lab03-ec2-user
```
This should work and show any EC2 instances in your account (or an empty list if none exist).

### Step 4: Test EC2 Write Access
```bash
aws ec2 run-instances \
  --image-id ami-0c55b159cbfafe1f0 \
  --instance-type t2.micro \
  --profile lab03-ec2-user
```
This should fail with an access denied error because the user only has read-only access to EC2.

## üîê Part 5: Create a Custom IAM Policy (Advanced)

### Step 1: Create a JSON Policy Document
First, create a file named `specific-bucket-policy.json` with the following content:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:ListAllMyBuckets",
                "s3:GetObject"
            ],
            "Resource": [
                "arn:aws:s3:::YOUR-SPECIFIC-BUCKET-NAME",
                "arn:aws:s3:::YOUR-SPECIFIC-BUCKET-NAME/*",
                "arn:aws:s3:::*"
            ]
        }
    ]
}
```
Replace `YOUR-SPECIFIC-BUCKET-NAME` with the name of a bucket you created in previous labs.

### Step 2: Create the Policy in AWS
```bash
aws iam create-policy \
  --policy-name SpecificBucketReadOnly \
  --policy-document file://specific-bucket-policy.json
```
Make note of the policy ARN in the output.

### Step 3: Create a New Group with the Custom Policy
```bash
aws iam create-group --group-name lab03-specific-bucket-group

aws iam attach-group-policy \
  --group-name lab03-specific-bucket-group \
  --policy-arn <POLICY_ARN_FROM_PREVIOUS_STEP>
```

### Step 4: Create a User and Add to the Group
```bash
aws iam create-user --user-name lab03-specific-bucket-user

aws iam add-user-to-group \
  --user-name lab03-specific-bucket-user \
  --group-name lab03-specific-bucket-group
```

### Step 5: Create Access Keys and Test
Follow the same steps as before to create access keys and set up a profile for this user, then test access to the specific bucket.

## üß™ Challenge Tasks

Now that you've learned the basics, try these additional challenges:

### Challenge 1: Multi-group Permissions
1. Create a user that belongs to both the S3 read-only and EC2 read-only groups
2. Test that this user has read access to both services

### Challenge 2: Custom Inline Policy
1. Create a user with an inline policy (not attached to a group)
2. Make this policy allow listing all S3 buckets but only reading objects from a specific bucket

### Challenge 3: Permissions Boundaries
1. Research IAM Permissions Boundaries in the AWS documentation
2. Create a permissions boundary that limits the scope of what your user can do
3. Apply it to a user and test the results

## üîç Troubleshooting Common Issues

### Access Denied Errors
- Verify the policy is correctly attached to the group
- Confirm the user is a member of the group
- Check for any explicit "Deny" statements that might override Allow statements
- Remember, by default, all actions are denied until explicitly allowed

### Can't Delete User or Group
- Users must be removed from all groups before deletion
- Groups must have all policies detached before deletion
- Users with access keys must have those keys deleted first

### Policy Not Taking Effect
- IAM changes can take a few moments to propagate globally
- Double-check policy syntax and ARNs for accuracy
- Verify you're testing with the correct user profile

## üßπ Cleanup - IMPORTANT!

To prevent clutter in your AWS account, clean up all resources created in this lab.

### Console Cleanup:
1. Go to IAM > Users
2. Select each lab user and click "Delete"
3. Go to IAM > User groups
4. Select each lab group and click "Delete"
5. For custom policies, go to IAM > Policies
6. Select the customer managed policies you created and delete them

### CLI Cleanup:

#### Delete Access Keys
```bash
aws iam list-access-keys --user-name lab03-ec2-user
aws iam delete-access-key --user-name lab03-ec2-user --access-key-id YOUR_ACCESS_KEY_ID

aws iam list-access-keys --user-name lab03-specific-bucket-user
aws iam delete-access-key --user-name lab03-specific-bucket-user --access-key-id YOUR_ACCESS_KEY_ID
```

#### Remove Users from Groups
```bash
aws iam remove-user-from-group \
  --user-name lab03-ec2-user \
  --group-name lab03-ec2read-group

aws iam remove-user-from-group \
  --user-name lab03-specific-bucket-user \
  --group-name lab03-specific-bucket-group
```

#### Delete Users
```bash
aws iam delete-user --user-name lab03-ec2-user
aws iam delete-user --user-name lab03-specific-bucket-user
```

#### Detach Policies from Groups
```bash
aws iam detach-group-policy \
  --group-name lab03-ec2read-group \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess

aws iam detach-group-policy \
  --group-name lab03-specific-bucket-group \
  --policy-arn YOUR_CUSTOM_POLICY_ARN
```

#### Delete Groups
```bash
aws iam delete-group --group-name lab03-ec2read-group
aws iam delete-group --group-name lab03-specific-bucket-group
```

#### Delete Custom Policy (if created)
```bash
aws iam delete-policy --policy-arn YOUR_CUSTOM_POLICY_ARN
```

## ‚úÖ What You've Learned

Congratulations! In this lab, you have:

1. Created IAM users and groups using both the AWS Console and CLI
2. Applied AWS managed policies to implement specific access controls
3. Created and applied a custom IAM policy for specific resources
4. Tested access permissions to verify they work as expected
5. Implemented the principle of least privilege by restricting permissions to only what's needed
6. Learned how to manage and organize access using IAM groups

These IAM skills are foundational for all AWS work, as they directly impact the security of your cloud resources. Understanding how to properly set up and manage permissions is critical for protecting your organization's data and services.

## üìö Additional Resources

- [IAM User Guide](https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html)
- [IAM Best Practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)
- [IAM Policy Examples](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_examples.html)
- [AWS CLI IAM Command Reference](https://docs.aws.amazon.com/cli/latest/reference/iam/index.html)
- [AWS Security Blog](https://aws.amazon.com/blogs/security/)

---

Happy Clouding ‚òÅÔ∏è!

